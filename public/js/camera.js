// Generated by CoffeeScript 1.3.3
(function() {
  $(function() {
    var e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m, g, y, b, w, E;
    r = $('input[type="file"]');
    m = $(".shutter");
    i = $("canvas");
    t = $(".arrows");
    v = $(".share-box");
    d = $(".share");
    l = $(".locate");
    s = $("textarea");
    o = $(".caption");
    a = $(".counter");
    e = $(".prompt");
    b = $(".spinnerContainer");
    w = 0;
    E = void 0;
    y = {
      lines: 12,
      length: 11,
      width: 4,
      radius: 12,
      color: "#FFF",
      hwaccel: !0
    };
    g = new Spinner(y);
    if ("standalone" in window.navigator && !window.navigator.standalone) {
      m.hide();
      e.show();
    }
    m.on("touchend", function() {
      r.trigger("click");
      $.get("/twitter_config", function(e) {
        var t;
        w = 140 - parseInt($.parseJSON(e).characters_reserved_per_media, 10);
        s.attr("maxLength", w);
        t = s.val() === "" ? s.attr("placeholder") : s.val();
        return a.text(t.length + "/" + w);
      });
      return _gaq.push([ "_trackEvent", "Photos", "Camera" ]);
    });
    s.on("keyup", function() {
      var e;
      e = s.val() === "" ? s.attr("placeholder") : s.val();
      return a.text(e.length + "/" + w);
    });
    r.on("change", function() {
      var e, t;
      e = this.files[0];
      E = e.type;
      t = new FileReader;
      t.onload = u;
      return t.readAsBinaryString(e);
    });
    f = new Hammer($("body")[0]);
    f.onswipe = function(e) {
      if (e.direction === "up") {
        console.log("swiped up");
        i.is(":visible") && i.animate({
          marginTop: "-2000px"
        }, "fast", function() {
          $(this).hide();
          o.hide();
          g.spin(b[0]);
          m.fadeOut("fast");
          t.hide();
          return h();
        });
        return _gaq.push([ "_trackEvent", "Photos", "Tweet" ]);
      }
    };
    c = function(e, n) {
      var r, s, u;
      i.show();
      s = i[0];
      r = s.getContext("2d");
      u = new Image;
      u.src = "data:" + E + ";base64," + e;
      return u.onload = function() {
        var e, i, a, f;
        a = 1;
        i = 1e3;
        e = 1e3;
        if (u.width > u.height) {
          if (u.width > i) {
            s.height = i / u.width * u.height;
            s.width = i;
          }
        } else if (u.height > e) {
          s.width = e / u.height * u.width;
          s.height = e;
        }
        r.clearRect(0, 0, s.width, s.height);
        if ((f = parseInt(n.Orientation, 10)) === 3 || f === 6 || f === 8) {
          r.translate(s.width / 2, s.height / 2);
          switch (parseInt(n.Orientation, 10)) {
           case 6:
            r.rotate(Math.PI / 2);
            break;
           case 3:
            r.rotate(Math.PI);
            break;
           case 8:
            r.rotate(Math.Pi * 3 / 2);
          }
          r.translate(-s.width / 2, -s.height / 2);
        }
        r.drawImage(u, 0, 0, s.width, s.height);
        return Caman("#photo-canvas", function() {
          return this.exposure(10).saturation(10).colorize(255, 200, 0, 10).noise(1).vignette("40%", 20).render(function() {
            console.log("finished");
            g.stop();
            m.prop("disabled", !1);
            o.show();
            return t.show();
          });
        });
      };
    };
    u = function() {
      var e = this;
      m.prop("disabled", !0);
      g.spin(b[0]);
      return m.animate({
        marginTop: window.innerHeight
      }, "swing", function() {
        var t, r;
        r = EXIF.readFromBinaryFile(new BinaryFile(e.result));
        t = n(e.result);
        return c(t, r);
      });
    };
    h = function() {
      var e, t;
      console.log("getting location");
      navigator.geolocation.getCurrentPosition(function(e) {
        var t, n;
        t = e.coords.latitude;
        return n = e.coords.longitude;
      });
      (function(e) {
        switch (e.code) {
         case e.TIMEOUT:
          return console.log("Geolocation error: Timeout");
         case e.POSITION_UNAVAILABLE:
          return console.log("Geolocation error: Position unavailable");
         case e.PERMISSION_DENIED:
          return console.log("Geolocation error: Permission denied");
         case e.UNKNOWN_ERROR:
          return console.log("Geolocation error: Unknown error");
        }
      });
      e = i[0].toDataURL();
      console.log("posting status");
      t = s.val() === "" ? s.attr("placeholder") : s.val();
      return $.post("/tweet", {
        status: t,
        photo: e,
        lat: latitude,
        "long": longitude
      }, function() {
        g.stop();
        b.html('<i class="icon-ok-sign" style="font-size: 300%; color: white;"></i>');
        return window.setTimeout(function() {
          b.html("");
          return p();
        }, 1e3);
      });
    };
    p = function() {
      m.fadeIn("fast");
      m.animate({
        marginTop: "50%"
      });
      i.css("margin-top", "0px");
      o.hide();
      s.val("");
      return r.val("");
    };
    return n = function(e) {
      var t, n, r, i, s, o, u, a, f, l, c, h, p, d;
      n = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";
      f = 0;
      t = 0;
      i = "";
      d = [];
      if (!e) return e;
      for (;;) {
        l = e.charCodeAt(f++);
        c = e.charCodeAt(f++);
        h = e.charCodeAt(f++);
        r = l << 16 | c << 8 | h;
        s = r >> 18 & 63;
        o = r >> 12 & 63;
        u = r >> 6 & 63;
        a = r & 63;
        d[t++] = n.charAt(s) + n.charAt(o) + n.charAt(u) + n.charAt(a);
        if (!(f < e.length)) break;
      }
      i = d.join("");
      p = e.length % 3;
      return (p ? i.slice(0, p - 3) : i) + "===".slice(p || 3);
    };
  });
}).call(this);